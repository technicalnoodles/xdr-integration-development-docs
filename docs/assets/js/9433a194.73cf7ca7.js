"use strict";(self.webpackChunkintegration_development_docs=self.webpackChunkintegration_development_docs||[]).push([[179],{764:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/newInvestigation-7723050636e62565b3096725886cdf77.png"},986:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/finishedInvestigation-ffc28a159b8e361298de3459082d5271.png"},4543:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/updated-response-6305057c69ed9225d12ed00ef4987127.png"},5798:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>r,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"relay-module/investigate/deliberation","title":"Deliberation Development","description":"To make a Deliberation integration, you can either continue to use the Generic Serverless Relay or update your Module Type to support the Deliberate endpoint.","source":"@site/mdx-docs/relay-module/investigate/00-deliberation.mdx","sourceDirName":"relay-module/investigate","slug":"/relay-module/investigate/deliberation","permalink":"/xdr-integration-development-docs/docs/relay-module/investigate/deliberation","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":1,"frontMatter":{"sidebar_position":1},"sidebar":"tutorialSidebar","previous":{"title":"Investigate Feature Development","permalink":"/xdr-integration-development-docs/docs/category/investigate-feature-development"},"next":{"title":"Referral Development","permalink":"/xdr-integration-development-docs/docs/relay-module/investigate/referral"}}');var i=t(4848),a=t(8453);const r={sidebar_position:1},o="Deliberation Development",l={},d=[{value:"Update Module Type JSON",id:"update-module-type-json",level:2},{value:"Create Deliberate API Endpoint",id:"create-deliberate-api-endpoint",level:2},{value:"Import Libraries",id:"import-libraries",level:3},{value:"Create Call to URLHaus API",id:"create-call-to-urlhaus-api",level:3},{value:"Create a Loop and Return Verdicts",id:"create-a-loop-and-return-verdicts",level:3},{value:"Docs Value",id:"docs-value",level:4},{value:"Observable Value",id:"observable-value",level:4},{value:"Type and Disposition values",id:"type-and-disposition-values",level:4},{value:"Deliberate API Endpoint",id:"deliberate-api-endpoint",level:3},{value:"Update Index file",id:"update-index-file",level:3},{value:"Test the Integration",id:"test-the-integration",level:3}];function c(e){const n={admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",img:"img",p:"p",pre:"pre",strong:"strong",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"deliberation-development",children:"Deliberation Development"})}),"\n",(0,i.jsxs)(n.p,{children:["To make a Deliberation integration, you can either continue to use the ",(0,i.jsx)(n.strong,{children:"Generic Serverless Relay"})," or update your Module Type to support the Deliberate endpoint."]}),"\n",(0,i.jsx)(n.h2,{id:"update-module-type-json",children:"Update Module Type JSON"}),"\n",(0,i.jsxs)(n.p,{children:["Go to the Module Maker and click on the ",(0,i.jsx)(n.strong,{children:"Open JSON from File"})," option on the top left of the page. Select the JSON file for the Wazuh module and open it."]}),"\n",(0,i.jsxs)(n.p,{children:["Once it is opened, it should look similar to the below:\n",(0,i.jsx)(n.img,{alt:"json",src:t(8318).A+"",width:"1045",height:"1148"})]}),"\n",(0,i.jsx)(n.p,{children:"Check the three tiles options so we make sure those stay there from the previous section and give them a description."}),"\n",(0,i.jsxs)(n.p,{children:["Now check the ",(0,i.jsx)(n.em,{children:"deliberate/observables"})," option and give it a description.\n",(0,i.jsx)(n.img,{alt:"updated json",src:t(9260).A+"",width:"1032",height:"1202"})]}),"\n",(0,i.jsx)(n.p,{children:"Now save the JSON and patch our module using the IROH Swagger docs."}),"\n",(0,i.jsxs)(n.p,{children:["You should get a response with the updated API endpoints and Deliberate should be listed in it.\n",(0,i.jsx)(n.img,{alt:"updated response",src:t(4543).A+"",width:"549",height:"250"})]}),"\n",(0,i.jsx)(n.h2,{id:"create-deliberate-api-endpoint",children:"Create Deliberate API Endpoint"}),"\n",(0,i.jsxs)(n.p,{children:["In your IDE, create a new folder in the ",(0,i.jsx)(n.strong,{children:"routes"})," folder called ",(0,i.jsx)(n.strong,{children:"deliberate"}),". Then create a new file called ",(0,i.jsx)(n.strong,{children:"deliberateRoute.js"})]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"deliberate file",src:t(8043).A+"",width:"369",height:"189"})}),"\n",(0,i.jsx)(n.p,{children:"To make sure our API endpoint works, we first need to make a few functions that will get our data and then return it in a format that Cisco XDR expects. We are going to use URLHaus for this functionality since Wazuh does not provide verdicts on wether something is malicious, suspicious, etc."}),"\n",(0,i.jsx)(n.h3,{id:"import-libraries",children:"Import Libraries"}),"\n",(0,i.jsxs)(n.p,{children:["First lets import two libraries: axios and the custom ",(0,i.jsx)(n.em,{children:"timeFunctions"})," we created earlier in this guide."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",metastring:'showLineNumbers title="deliberateRoute.js"',children:"const axios = require('axios');\nconst timeFunctions = require('../../utils/time.js');\n"})}),"\n",(0,i.jsx)(n.h3,{id:"create-call-to-urlhaus-api",children:"Create Call to URLHaus API"}),"\n",(0,i.jsx)(n.p,{children:"In the highlighted section, we added an asynchronous function that will reach out to the URLHaus API for any URL we give it."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",metastring:'showLineNumbers title="deliberateRoute.js"',children:"const axios = require('axios');\nconst timeFunctions = require('../../utils/time.js');\n// highlight-start\nconst getUrlState = async (url) => {\n  const params = new URLSearchParams();\n  params.append('url', url);\n  const response = await axios.post(\n    'https://urlhaus-api.abuse.ch/v1/url/',\n    params\n  );\n  return response.data;\n};\n// highlight-end\n"})}),"\n",(0,i.jsx)(n.h3,{id:"create-a-loop-and-return-verdicts",children:"Create a Loop and Return Verdicts"}),"\n",(0,i.jsx)(n.p,{children:"When Cisco XDR queries the deliberate endpoint, it will send an array of observables it wants the integration to check."}),"\n",(0,i.jsx)(n.p,{children:"Here is an example of what could be sent:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'[\n  {\n    "type": "domain",\n    "value": "ilo.brenz.pl"\n  },\n  {\n    "type": "url",\n    "value": "http://ilo.brenz.pl/file.dat"\n  },\n  {\n    "type": "email",\n    "value": "no-reply@internetbadguys.com"\n  },\n  {\n    "type": "sha256",\n    "value": "8fda14f91e27afec5c1b1f71d708775c9b6e2af31e8331bbf26751bc0583dc7e"\n  }\n]\n'})}),"\n",(0,i.jsx)(n.p,{children:"In this section we will only work with URLs."}),"\n",(0,i.jsx)(n.p,{children:"If your product supports any other observables beside URLs, you can make your integration check for those and do the related tasks needed to get data for them."}),"\n",(0,i.jsxs)(n.p,{children:["In the highlighted section below we are expecting to receive an array and then loop over that array. The first thing we do is make the object that we will add our verdicts to. We are calling this ",(0,i.jsx)(n.em,{children:"returnData"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["Then we loop through the array provided to the function and then check if it is a URL type. If it is, we then call the ",(0,i.jsx)(n.em,{children:"getUrlState"})," function with the observable value."]}),"\n",(0,i.jsx)(n.admonition,{type:"info",children:(0,i.jsxs)(n.p,{children:["You do ",(0,i.jsx)(n.strong,{children:"NOT"})," need to return a value for everything sent to the relay module. If your relay will only process sha256s, then you can ignore all other types of observables and only return data on the sha256s."]})}),"\n",(0,i.jsxs)(n.p,{children:["If we receive a verdict from the URLHaus API, we add the verdict info to the ",(0,i.jsx)(n.em,{children:"returnData"})," variable."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",metastring:'showLineNumbers title="deliberateRoute.js"',children:"const axios = require('axios');\nconst timeFunctions = require('../../utils/time.js');\n\nconst getUrlState = async (url) => {\n  const params = new URLSearchParams();\n  params.append('url', url);\n  const response = await axios.post(\n    'https://urlhaus-api.abuse.ch/v1/url/',\n    params\n  );\n  return response.data;\n};\n\n// highlight-start\nconst urlLoop = async (observableArray) => {\n  let returnData = { verdicts: { count: 0, docs: [] } };\n  for (const observable of observableArray) {\n    if (observable.type === 'url') {\n      console.log(`Processing URL: ${observable.value}`);\n      const urlState = await getUrlState(observable.value);\n      const url_status = await urlState.query_status;\n      if (url_status === 'no_results') {\n        console.log(`No results for ${observable.value}`);\n      }\n      if (url_status === 'ok') {\n        returnData['verdicts']['count'] += 1;\n        await returnData['verdicts']['docs'].push({\n          type: 'verdict',\n          disposition: 2,\n          observable: {\n            value: observable.value,\n            type: 'url',\n          },\n          disposition_name: 'Malicious',\n          valid_time: {\n            start_time: new Date(timeFunctions.getNow() * 1000).toISOString(),\n            end_time: new Date(\n              (timeFunctions.getNow() + 21600) * 1000\n            ).toISOString(), // 6 hour validity\n          },\n        });\n        console.log(returnData);\n      }\n    }\n  }\n\n  return returnData;\n};\n// highlight-end\n"})}),"\n",(0,i.jsx)(n.p,{children:"Lets break down the above code a bit more. When you return data to Cisco XDR for the deliberate endpoint. You need to provide it in the below format:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:'"data": {\n        "verdicts": {\n          "count": 1,\n          "docs": [\n            {\n              "valid_time": {\n                "start_time": "2025-06-03T15:03:54.000Z",\n                "end_time": "2025-06-03T21:03:54.000Z"\n              },\n              "observable": {\n                "value": "https://globalpanelinc.com/wnx/fGb",\n                "type": "url"\n              },\n              "type": "verdict",\n              "disposition": 2,\n              "disposition_name": "Malicious"\n            }\n          ]\n        }\n      }\n'})}),"\n",(0,i.jsxs)(n.p,{children:["In our function we have ",(0,i.jsx)(n.code,{children:"let returnData = { verdicts: { count: 0, docs: [] } }"})]}),"\n",(0,i.jsxs)(n.p,{children:["The only things we need to update in this object are the ",(0,i.jsx)(n.em,{children:"count"})," and the ",(0,i.jsx)(n.em,{children:"docs"})," array. The ",(0,i.jsx)(n.em,{children:"count"})," is the number of verdicts that are being returned."]}),"\n",(0,i.jsx)(n.h4,{id:"docs-value",children:"Docs Value"}),"\n",(0,i.jsxs)(n.p,{children:["The docs value is what contains all the verdicts being returned. Each verdict needs to be an object itself appended to the ",(0,i.jsx)(n.em,{children:"docs"})," array."]}),"\n",(0,i.jsxs)(n.p,{children:["The first value you see here is the ",(0,i.jsx)(n.em,{children:"valid_time"}),", it needs a ",(0,i.jsx)(n.em,{children:"start_time"})," and an ",(0,i.jsx)(n.em,{children:"end_time"}),". These values determine how long Cisco XDR will cache a verdict from your product. We use a six hour timeframe for it being valid. But if your product updates these verdicts frequently then having it lower could be a better idea."]}),"\n",(0,i.jsx)(n.h4,{id:"observable-value",children:"Observable Value"}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.em,{children:"observable"})," field contains the same info that was sent to the relay module. Add the ",(0,i.jsx)(n.em,{children:"type"})," and the ",(0,i.jsx)(n.em,{children:"value"})," that was provided in this field."]}),"\n",(0,i.jsx)(n.h4,{id:"type-and-disposition-values",children:"Type and Disposition values"}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.em,{children:"type"})," should always be ",(0,i.jsx)(n.em,{children:"verdict"})," from this API endpoint. But there are others we will go over in another section."]}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.em,{children:"disposition"})," value is the a numeric identifier of the type of verdict being returned. These can be 1,2,3,4,5."]}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.em,{children:"disposition_name"})," can be 1 of 5 values: Clean, Malicious, Suspicious, COmmon, and Unknown."]}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.em,{children:"disposition"})," and ",(0,i.jsx)(n.em,{children:"dispostion_name"})," map to each other like so:"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:'{1 "Clean", 2 "Malicious", 3 "Suspicious", 4 "Common", 5 "Unknown"}'})}),"\n",(0,i.jsx)(n.p,{children:"Those are all the values needed to be added to a verdict."}),"\n",(0,i.jsx)(n.h3,{id:"deliberate-api-endpoint",children:"Deliberate API Endpoint"}),"\n",(0,i.jsx)(n.p,{children:"The last bit of code we need to add is the actual API Endpoint route."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"module.exports = (app) => {\n  app.post('/deliberate/observables', async (req, res) => {\n    const observables = req.body;\n    const returnData = await urlLoop(observables);\n    res.send({ data: returnData });\n  });\n};\n"})}),"\n",(0,i.jsx)(n.p,{children:"We will add this bit to the end of the file and it should look like the below:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",metastring:'showLineNumbers title="deliberateRoute.js"',children:"const axios = require('axios');\nconst timeFunctions = require('../../utils/time.js');\n\nconst getUrlState = async (url) => {\n  const params = new URLSearchParams();\n  params.append('url', url);\n  const response = await axios.post(\n    'https://urlhaus-api.abuse.ch/v1/url/',\n    params\n  );\n  return response.data;\n};\n\nconst urlLoop = async (observableArray) => {\n  let returnData = { verdicts: { count: 0, docs: [] } };\n  for (const observable of observableArray) {\n    if (observable.type === 'url') {\n      console.log(`Processing URL: ${observable.value}`);\n      const urlState = await getUrlState(observable.value);\n      const url_status = await urlState.query_status;\n      if (url_status === 'no_results') {\n        console.log(`No results for ${observable.value}`);\n      }\n      if (url_status === 'ok') {\n        returnData['verdicts']['count'] += 1;\n        await returnData['verdicts']['docs'].push({\n          type: 'verdict',\n          disposition: 2,\n          observable: {\n            value: observable.value,\n            type: 'url',\n          },\n          disposition_name: 'Malicious',\n          valid_time: {\n            start_time: new Date(timeFunctions.getNow() * 1000).toISOString(),\n            end_time: new Date(\n              (timeFunctions.getNow() + 21600) * 1000\n            ).toISOString(), // 6 hour validity\n          },\n        });\n        console.log(returnData);\n      }\n    }\n  }\n\n  return returnData;\n};\n\n// highlight-start\nmodule.exports = (app) => {\n  app.post('/deliberate/observables', async (req, res) => {\n    const observables = req.body;\n    const returnData = await urlLoop(observables);\n    res.send({ data: returnData });\n  });\n};\n// highlight-end\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Once this is done, we can import this into our ",(0,i.jsx)(n.em,{children:"index.js"})," file."]}),"\n",(0,i.jsx)(n.h3,{id:"update-index-file",children:"Update Index file"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",metastring:'showLineNumbers title="index.js"',children:"const express = require('express');\nconst axios = require('axios');\nconst bodyParser = require('body-parser');\nconst port = 6000;\nconst WAZUH_API =\n  'https://ec2-3-134-247-125.us-east-2.compute.amazonaws.com:55000';\n\nconst app = express();\napp.use(bodyParser.json());\n\nrequire('./routes/health/healthRoute.js')(app);\nrequire('./routes/tiles/tileRoute.js')(app);\n// highlight-next-line\nrequire('./routes/deliberate/deliberateRoute.js')(app);\n\napp.listen(port, () => {\n  console.log(`Example app listening on port ${port}`);\n});\n"})}),"\n",(0,i.jsx)(n.p,{children:"Now lets test the integration."}),"\n",(0,i.jsx)(n.h3,{id:"test-the-integration",children:"Test the Integration"}),"\n",(0,i.jsxs)(n.p,{children:["Go to the ",(0,i.jsx)(n.strong,{children:"Investigate"})," page in Cisco XDR and past the below URL into the text box.\n",(0,i.jsx)(n.code,{children:"https://egnersi.com/8papP/0.6922216472156167.dat"})]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"investigate",src:t(764).A+"",width:"1370",height:"666"})}),"\n",(0,i.jsxs)(n.p,{children:["Click on the blue ",(0,i.jsx)(n.strong,{children:"Investigate"})," button and it will go to a new page and start querying your relay module."]}),"\n",(0,i.jsxs)(n.p,{children:["Let the investigation finish and then lok for the URL we submitted int he right pane called ",(0,i.jsx)(n.strong,{children:"Assets and Observables"}),". Click on the down arrow circle and expand the ",(0,i.jsx)(n.em,{children:"2 Verdicts"})," section at the top. We should see the ",(0,i.jsx)(n.em,{children:"Wazuh"})," verdict here (but its actually from URLHaus)."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"investigate",src:t(986).A+"",width:"3436",height:"1414"})}),"\n",(0,i.jsx)(n.p,{children:"This concludes the section on creating a _deliberation* integration. Next we will create a Referral integration."})]})}function h(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},8043:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/deliberateFile-7b3f78c19415b7e8033802e232e92617.png"},8318:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/default-json-5cdb98f4f9794e1df872c0b32cc4ca6d.png"},8453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>o});var s=t(6540);const i={},a=s.createContext(i);function r(e){const n=s.useContext(a);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),s.createElement(a.Provider,{value:n},e.children)}},9260:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/updated-json-001de4c865bccea8f92391d39c5e9925.png"}}]);